<script>
  // ⬇️ Tu API de Apps Script (/exec?action=data)
  const API_URL = "https://script.google.com/macros/s/AKfycbyZLEqn4IWKk7ShT2-Zc9vEwQUvjYDHhywTyxqnw5xF07YduCsokWQ0ar7BP7MA3enP/exec?action=data";

  // ========= Utiles generales =========
  const $ = (id) => document.getElementById(id);
  function deb(fn, d){ let t=0; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), d||250); }; }

  // Normaliza encabezados (quita acentos, espacios/puntuación y pone MAYÚSC.)
  function normHeader(s){
    return String(s||"")
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")   // sin acentos
      .toUpperCase().replace(/[^A-Z0-9]/g,"");           // solo A-Z0-9
  }

  // Normaliza RUT/RUN: quita puntos/espacios, deja dígitos y K, y compara sin guion
  function normalizeRut(r){
    return String(r||"")
      .toUpperCase()
      .replace(/\./g,"").replace(/\s+/g,"")
      .replace(/[^0-9K-]/g,"")
      .replace(/-/g,""); // comparamos sin guion
  }
  function equalsRut(a,b){ return normalizeRut(a) === normalizeRut(b); }

  // Sinónimos por campo (versiones normalizadas, se hace "includes")
  const FIELD_SYNONYMS = {
    rut: [
      "RUT","RUN","RUNSINPUNTOS","RUTSINPUNTOS","RUTRUN",
      "RUNCONGUION","RUTCONGUION","RUNSINDOSPUNTOS","RUTSINDOSPUNTOS",
      "RUNSINGUION","R.U.N"
    ],
    cartola: ["NCARTOLAINTERNA","NDECARTOLA","NUMERODECARTOLA","CARTOLA"],
    familia: ["NFAMILIA","NDEFAMILIA","NUMERODEFAMILIA","FAMILIA"],
    nombres: ["NOMBRES","NOMBRE","NOMBRESAPELLIDOS","NOMBRE(S)"],
    apPat: ["APELLIDOPATERNO","APPATERNO","AP.PATERNO","PATERNO"],
    apMat: ["APELLIDOMATERNO","APMATERNO","AP.MATERNO","MATERNO"],
    direccion: ["DIRECCION","DIRECCIONDOMICILIO","DOMICILIO","DIRECCIÓN"],
    telefono: ["NUMERODECONTACTOPRINCIPAL","TELEFONO","TELEFONO1","TEL","CONTACTO","FONO","NUMEROTELEFONO"],
    sector: ["SECTOR"],
    riesgo: ["CLASIFICACIONDELRIESGOFAMILIAR","CLASIFICACIONDERIESGO","CLASIFICACIONRIESGO","RIESGO"]
  };

  // Construye un mapa de columnas detectadas a partir de la PRIMERA fila
  function buildKeyMap(sampleRow){
    const headers = Object.keys(sampleRow||{}).map(k => [k, normHeader(k)]);
    const pick = (synList) => {
      for (const [orig, norm] of headers){
        if (synList.some(s => norm.includes(s))) return orig;
      }
      return null;
    };
    return {
      rut      : pick(FIELD_SYNONYMS.rut),
      cartola  : pick(FIELD_SYNONYMS.cartola),
      familia  : pick(FIELD_SYNONYMS.familia),
      nombres  : pick(FIELD_SYNONYMS.nombres),
      apPat    : pick(FIELD_SYNONYMS.apPat),
      apMat    : pick(FIELD_SYNONYMS.apMat),
      direccion: pick(FIELD_SYNONYMS.direccion),
      telefono : pick(FIELD_SYNONYMS.telefono),
      sector   : pick(FIELD_SYNONYMS.sector),
      riesgo   : pick(FIELD_SYNONYMS.riesgo)
    };
  }

  // Estado
  let DATA = [];
  let KEYMAP = null;

  function joinName(row){
    const get = (k)=> row[KEYMAP[k]] ?? "";
    const parts = [get("nombres"), get("apPat"), get("apMat")]
      .map(x => String(x||"").trim())
      .filter(Boolean);
    return parts.join(" ").toUpperCase() || "—";
  }
  function setRow(row){
    const get = (k)=> row[KEYMAP[k]] ?? "—";
    $("vNombre").textContent    = joinName(row);
    $("vCartola").textContent   = get("cartola");
    $("vFamilia").textContent   = get("familia");
    $("vDireccion").textContent = get("direccion");
    $("vTelefono").textContent  = get("telefono");
    $("vSector").textContent    = get("sector");
    $("vRiesgo").textContent    = get("riesgo");
  }
  function clearValues(){
    ["vNombre","vCartola","vFamilia","vDireccion","vTelefono","vSector","vRiesgo"]
      .forEach(id => $(id).textContent = "—");
  }

  function showMissingCols(){
    const available = Object.keys(DATA[0]||{});
    const missing = Object.entries(KEYMAP).filter(([k,v])=>!v).map(([k])=>k);
    const msg = [
      "No pude detectar todas las columnas necesarias.",
      "Faltan: " + (missing.join(", ") || "—"),
      "Encabezados disponibles en la hoja: " + (available.join(" | ") || "—")
    ].join("  ·  ");
    $("status").textContent = msg;
  }

  // Buscar por RUN
  function buscar(){
    const input = $("rut").value;
    const q = normalizeRut(input);
    if (!q){ $("status").textContent = "Ingresa un RUN"; clearValues(); return; }
    $("buscar").disabled = true;
    $("status").textContent = "Buscando…";

    if (!KEYMAP || !KEYMAP.rut){ showMissingCols(); $("buscar").disabled=false; return; }

    // Busca coincidencia exacta (normalizada)
    let found = DATA.find(r => equalsRut(String(r[KEYMAP.rut]||""), q));

    // Si no encontró, intenta con trimming extra (por si vienen ceros o espacios raros)
    if (!found){
      found = DATA.find(r => normalizeRut(String(r[KEYMAP.rut]||"")).endsWith(q));
    }

    if (found){
      setRow(found);
      $("status").textContent = "OK";
    } else {
      clearValues();
      $("status").textContent = "No encontrado";
    }
    $("buscar").disabled = false;
  }

  // Carga de datos
  async function loadData(){
    $("status").textContent = "Cargando datos…";
    try{
      const r = await fetch(API_URL, { mode:'cors' });
      const txt = await r.text();
      // Si por error vuelve HTML
      if (txt.trim().startsWith("<!doctype")) throw new Error("La API devolvió HTML. Revisa permisos/URL.");
      const j = JSON.parse(txt);
      if (!j || !j.ok) throw new Error(j?.error || "Respuesta inválida.");
      DATA = Array.isArray(j.rows) ? j.rows : [];

      if (DATA.length === 0){
        $("status").textContent = "Sin filas en la hoja.";
        return;
      }
      KEYMAP = buildKeyMap(DATA[0]);

      // Si falta alguna clave importante, mostramos qué hay
      if (!KEYMAP.rut) showMissingCols();
      else $("status").textContent = "Listo";
    } catch(e){
      $("status").textContent = "Error: " + (e.message || e);
      console.error(e);
    }
  }

  // Eventos
  $("buscar").addEventListener("click", buscar);
  $("rut").addEventListener("keydown", (e)=>{ if (e.key === "Enter") buscar(); });

  // Init
  loadData();
</script>
